{"version":3,"file":"virtual-scroll-helper-module.js","sources":["../../../src/virtual-scroll-helper/virtual-scroll-helper.ts","../../../src/virtual-scroll-helper/index.ts","../../../src/virtual-scroll-helper/virtual-scroll-helper-module.ts"],"sourcesContent":["import {Directive, ElementRef, HostListener, OnDestroy, OnInit} from \"@angular/core\";\nimport {ViewObserver} from \"@co.mmons/ionic-extensions/view-observer\";\nimport {sleep} from \"@co.mmons/js-utils/core\";\nimport {Platform} from \"@ionic/angular\";\nimport {Subscription} from \"rxjs\";\n\n@Directive({\n    selector: \"ion-virtual-scroll\",\n})\nexport class VirtualScrollHelper implements OnInit, OnDestroy {\n\n    constructor(private readonly element: ElementRef<HTMLIonVirtualScrollElement>, private platform: Platform) {\n    }\n\n    private viewObserver: ViewObserver;\n\n    private scheduleRerender: number = 0;\n\n    private rendering: boolean;\n\n    private scrollPosition: number;\n\n    private scrollHeight: number;\n\n    private content: HTMLIonContentElement;\n\n    private contentScrollEndListener: (ev: Event) => void;\n\n    private activationSubscription: Subscription;\n\n\n    private async contentScrolled() {\n        if (this.scheduleRerender <= 0 && this.viewObserver.isActive()) {\n            const scroll = await this.content.getScrollElement();\n            this.scrollPosition = scroll.scrollTop;\n            this.scrollHeight = scroll.scrollHeight;\n        }\n    }\n\n    @HostListener(\"window:resize\")\n    markAsDirtyWhenInactive() {\n        if (!this.viewObserver.isActive()) {\n            this.scheduleRerender++;\n        }\n    }\n\n    private activated() {\n        if (this.scheduleRerender > 0) {\n            this.rerender();\n        }\n    }\n\n    async rerender() {\n\n        if (this.rendering) {\n            this.scheduleRerender++;\n            return;\n        }\n\n        this.rendering = true;\n\n        const inputScrollPosition = this.scrollPosition;\n        const inputScrollHeight = this.scrollHeight;\n\n        await this.element.nativeElement.checkRange(0);\n\n        if (inputScrollPosition > 0 && inputScrollHeight > 0) {\n            const scroll = await this.content.getScrollElement();\n\n            let scrollHeight = scroll.scrollHeight;\n\n            for (let i = 0; i < 20; i++) {\n                await sleep(50);\n\n                if (scroll.scrollHeight === scrollHeight) {\n                    break;\n                } else {\n                    scrollHeight = scroll.scrollHeight;\n                }\n            }\n\n            scroll.scrollTop = scroll.scrollHeight * (this.scrollPosition / this.scrollHeight);\n        }\n\n        this.rendering = false;\n        this.scheduleRerender--;\n\n        if (this.scheduleRerender > 0) {\n            this.rerender();\n        } else if (this.scheduleRerender < 0) {\n            this.scheduleRerender = 0;\n        }\n    }\n\n    ngOnInit() {\n        this.content = this.element.nativeElement.closest(\"ion-content\");\n        this.content.scrollEvents = true;\n        this.content.addEventListener(\"ionScrollEnd\", this.contentScrollEndListener = () => this.contentScrolled());\n\n        this.viewObserver = new ViewObserver(this.content, this.platform);\n        this.activationSubscription = this.viewObserver.activated.subscribe(() => this.activated());\n    }\n\n    ngOnDestroy() {\n        this.content.removeEventListener(\"ionScrollEnd\" as any, this.contentScrollEndListener);\n        this.activationSubscription.unsubscribe();\n        this.viewObserver.destroy();\n    }\n}\n","import {CommonModule} from \"@angular/common\";\nimport {NgModule} from \"@angular/core\";\nimport {IonicModule} from \"@ionic/angular\";\nimport {VirtualScrollHelper} from \"./virtual-scroll-helper\";\n\nexport {VirtualScrollHelper} from \"./virtual-scroll-helper\";\n\n@NgModule({\n    declarations: [VirtualScrollHelper],\n    exports: [VirtualScrollHelper],\n    imports: [CommonModule, IonicModule],\n})\nexport class VirtualScrollHelperModule {\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}