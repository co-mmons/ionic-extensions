import { ChangeDetectorRef, Component, EventEmitter, forwardRef, HostBinding, HostListener, Input, Output, ViewChild } from "@angular/core";
import { NG_VALUE_ACCESSOR } from "@angular/forms";
import { IonInput, Platform } from "@ionic/angular";
export const tagsValueAccessor = {
    provide: NG_VALUE_ACCESSOR,
    useExisting: forwardRef(() => TagsInput),
    multi: true
};
export class TagsInput {
    constructor(plt, ref) {
        this.plt = plt;
        this.ref = ref;
        this.readonly = false;
        this.hideRemove = false;
        this.maxTags = -1;
        this.placeholder = "+Tag";
        this.type = "text";
        this.separatorStr = ",";
        this.canEnterAdd = true;
        this.canBackspaceRemove = false;
        this._once = false;
        this.change = new EventEmitter();
        this.ionFocus = new EventEmitter();
        this.ionBlur = new EventEmitter();
        this._editTag = "";
        this._tags = [];
        this._isFocus = false;
    }
    set once(value) {
        if (typeof value === "string") {
            this._once = true;
        }
        else {
            this._once = value;
        }
    }
    get once() {
        return this._once;
    }
    keyAddTag() {
        const tagStr = this._editTag.trim();
        if (!this.canEnterAdd) {
            return;
        }
        if (!this.verifyTag(tagStr)) {
            return;
        }
        if (this.once && !this.isOnce(tagStr)) {
            this._editTag = "";
            return;
        }
        this.pushTag(tagStr);
    }
    separatorStrAddTag() {
        if (!this.separatorStr) {
            return;
        }
        if (this._editTag.indexOf(this.separatorStr) > -1) {
            const tags = this._editTag.split(this.separatorStr);
            for (let i = 0; i < tags.length; i++) {
                const tag = tags[i].trim();
                if (i < tags.length - 1) {
                    if (this.verifyTag(tag) && this.isOnce(tag)) {
                        this.pushTag(tag);
                    }
                }
                else {
                    this._editTag = tag;
                }
            }
        }
    }
    keyRemoveTag(ev) {
        if (!this.canBackspaceRemove) {
            return;
        }
        if (this._editTag === "") {
            this.removeTag(-1);
            this._editTag = "";
        }
    }
    btnRemoveTag($index) {
        this.removeTag($index);
        this.input.setFocus();
    }
    verifyTag(tagStr) {
        if (typeof this.verifyFn === "function") {
            if (!this.verifyFn(tagStr)) {
                this._editTag = "";
                return false;
            }
            else {
                return true;
            }
        }
        if (!tagStr.trim()) {
            this._editTag = "";
            return false;
        }
        else {
            return true;
        }
    }
    pushTag(tagStr) {
        if (!this._tags) {
            this._tags = [];
        }
        if (this._tags.indexOf(tagStr) > -1) {
            return;
        }
        if (this.maxTags !== -1 && this._tags.length >= this.maxTags) {
            this._editTag = "";
            return;
        }
        this._tags.push(tagStr.trim());
        this.sortTags();
        this.ref.detectChanges();
        this.change.emit(this._tags.slice());
        this._editTag = "";
        if (this._onChanged) {
            this._onChanged(this._tags.slice());
        }
    }
    sortTags() {
        if (this.sortable && this._tags) {
            if (this.sortFn) {
                this._tags.sort((a, b) => this.sortFn(a, b));
            }
            else {
                this._tags.sort((a, b) => a.localeCompare(b));
            }
        }
    }
    removeTag($index) {
        if (this._tags && this._tags.length > 0) {
            if ($index === -1) {
                this._tags.pop();
                this.change.emit(this._tags);
            }
            else if ($index > -1) {
                this._tags.splice($index, 1);
                this.change.emit(this._tags);
            }
            if (this._onChanged) {
                this._onChanged(this._tags.slice());
            }
        }
    }
    isOnce(tagStr) {
        const tags = this._tags;
        if (!tags) {
            return true;
        }
        return tags.every((e) => {
            return e !== tagStr;
        });
    }
    _click(ev) {
        if (!this._isFocus) {
        }
        this.focus();
        ev.preventDefault();
        ev.stopPropagation();
    }
    blur() {
        if (this._editTag) {
            this.pushTag(this._editTag);
        }
        if (this._isFocus) {
            this._isFocus = false;
            this.ionBlur.emit(this._tags);
        }
    }
    focus() {
        if (!this._isFocus) {
            this._isFocus = true;
            if (this.input) {
                this.input.setFocus();
            }
            this.ionFocus.emit(this._tags);
        }
    }
    writeValue(val) {
        this._tags = val;
    }
    registerOnChange(fn) {
        this._onChanged = fn;
    }
    registerOnTouched(fn) {
        this._onTouched = fn;
    }
    setValue(val) {
        this._tags = val;
        this.sortTags();
    }
}
TagsInput.decorators = [
    { type: Component, args: [{
                selector: "ionx-tags-input",
                providers: [tagsValueAccessor],
                template: "<div class=\"ionx-tags-input-wrapper\">\n    <ion-chip *ngFor=\"let tag of _tags; let $index = index;\" outline=\"true\" [class.ion-activatable]=\"false\">\n        <div>{{tag}}</div>\n        <ion-icon name=\"close\" *ngIf=\"!hideRemove && !readonly\" (click)=\"btnRemoveTag($index)\" [class.ion-activatable]=\"!readonly\"></ion-icon>\n    </ion-chip>\n</div>\n\n<ion-input *ngIf=\"!readonly\"\n           [disabled]=\"readonly\"\n           class=\"ionx-tags-input-input\"\n           [type]=\"type\"\n           [placeholder]=\"placeholder\"\n           [(ngModel)]=\"_editTag\"\n           (ionBlur)=\"blur()\"\n           (keyup.backspace)=\"keyRemoveTag($event); false\"\n           (keyup)=\"separatorStrAddTag()\" (keyup.enter)=\"keyAddTag()\"></ion-input>\n",
                styles: [":host{display:block}:host ion-chip{margin-left:0}:host-context(.item-label-stacked){width:100%}\n"]
            },] }
];
TagsInput.ctorParameters = () => [
    { type: Platform },
    { type: ChangeDetectorRef }
];
TagsInput.propDecorators = {
    readonly: [{ type: HostBinding, args: ["class.readonly",] }, { type: Input }],
    hideRemove: [{ type: Input }],
    maxTags: [{ type: Input }],
    placeholder: [{ type: Input }],
    type: [{ type: Input }],
    separatorStr: [{ type: Input }],
    canEnterAdd: [{ type: Input }],
    canBackspaceRemove: [{ type: Input }],
    verifyFn: [{ type: Input }],
    sortFn: [{ type: Input }],
    sortable: [{ type: Input }],
    once: [{ type: Input }],
    change: [{ type: Output }],
    ionFocus: [{ type: Output }],
    ionBlur: [{ type: Output }],
    input: [{ type: ViewChild, args: [IonInput, { static: false },] }],
    _click: [{ type: HostListener, args: ["click", ["$event"],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy1pbnB1dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWdzLWlucHV0L3RhZ3MtaW5wdXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDMUksT0FBTyxFQUF1QixpQkFBaUIsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZFLE9BQU8sRUFBQyxRQUFRLEVBQUUsUUFBUSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEQsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUc7SUFDN0IsT0FBTyxFQUFFLGlCQUFpQjtJQUMxQixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQztJQUN4QyxLQUFLLEVBQUUsSUFBSTtDQUNkLENBQUM7QUFRRixNQUFNLE9BQU8sU0FBUztJQUVsQixZQUFtQixHQUFhLEVBQVMsR0FBc0I7UUFBNUMsUUFBRyxHQUFILEdBQUcsQ0FBVTtRQUFTLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBSy9ELGFBQVEsR0FBWSxLQUFLLENBQUM7UUFHMUIsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUc1QixZQUFPLEdBQVcsQ0FBQyxDQUFDLENBQUM7UUFHckIsZ0JBQVcsR0FBVyxNQUFNLENBQUM7UUFHN0IsU0FBSSxHQUFXLE1BQU0sQ0FBQztRQUd0QixpQkFBWSxHQUFXLEdBQUcsQ0FBQztRQUczQixnQkFBVyxHQUFZLElBQUksQ0FBQztRQUc1Qix1QkFBa0IsR0FBWSxLQUFLLENBQUM7UUFZcEMsVUFBSyxHQUFZLEtBQUssQ0FBQztRQWlCdkIsV0FBTSxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRy9DLGFBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQUUs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QixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsRUFBTztRQUNwQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsaUJBQWlCLENBQUMsRUFBTztRQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsUUFBUSxDQUFDLEdBQVE7UUFDYixJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztRQUNqQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDcEIsQ0FBQzs7O1lBblJKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsaUJBQWlCO2dCQUMzQixTQUFTLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztnQkFDOUIsMHdCQUE4Qjs7YUFFakM7OztZQWJpQixRQUFRO1lBRmxCLGlCQUFpQjs7O3VCQXFCcEIsV0FBVyxTQUFDLGdCQUFnQixjQUM1QixLQUFLO3lCQUdMLEtBQUs7c0JBR0wsS0FBSzswQkFHTCxLQUFLO21CQUdMLEtBQUs7MkJBR0wsS0FBSzswQkFHTCxLQUFLO2lDQUdMLEtBQUs7dUJBR0wsS0FBSztxQkFHTCxLQUFLO3VCQUdMLEtBQUs7bUJBTUwsS0FBSztxQkFjTCxNQUFNO3VCQUdOLE1BQU07c0JBR04sTUFBTTtvQkFHTixTQUFTLFNBQUMsUUFBUSxFQUFFLEVBQUMsTUFBTSxFQUFFLEtBQUssRUFBQztxQkEySm5DLFlBQVksU0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgZm9yd2FyZFJlZiwgSG9zdEJpbmRpbmcsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE91dHB1dCwgVmlld0NoaWxkfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1J9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xuaW1wb3J0IHtJb25JbnB1dCwgUGxhdGZvcm19IGZyb20gXCJAaW9uaWMvYW5ndWxhclwiO1xuXG5leHBvcnQgY29uc3QgdGFnc1ZhbHVlQWNjZXNzb3IgPSB7XG4gICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gVGFnc0lucHV0KSxcbiAgICBtdWx0aTogdHJ1ZVxufTtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6IFwiaW9ueC10YWdzLWlucHV0XCIsXG4gICAgcHJvdmlkZXJzOiBbdGFnc1ZhbHVlQWNjZXNzb3JdLFxuICAgIHRlbXBsYXRlVXJsOiBcInRhZ3MtaW5wdXQuaHRtbFwiLFxuICAgIHN0eWxlVXJsczogW1widGFncy1pbnB1dC5zY3NzXCJdXG59KVxuZXhwb3J0IGNsYXNzIFRhZ3NJbnB1dCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yIHtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBwbHQ6IFBsYXRmb3JtLCBwdWJsaWMgcmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge1xuICAgIH1cblxuICAgIEBIb3N0QmluZGluZyhcImNsYXNzLnJlYWRvbmx5XCIpXG4gICAgQElucHV0KClcbiAgICByZWFkb25seTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgQElucHV0KClcbiAgICBoaWRlUmVtb3ZlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBASW5wdXQoKVxuICAgIG1heFRhZ3M6IG51bWJlciA9IC0xO1xuXG4gICAgQElucHV0KClcbiAgICBwbGFjZWhvbGRlcjogc3RyaW5nID0gXCIrVGFnXCI7XG5cbiAgICBASW5wdXQoKVxuICAgIHR5cGU6IHN0cmluZyA9IFwidGV4dFwiO1xuXG4gICAgQElucHV0KClcbiAgICBzZXBhcmF0b3JTdHI6IHN0cmluZyA9IFwiLFwiO1xuXG4gICAgQElucHV0KClcbiAgICBjYW5FbnRlckFkZDogYm9vbGVhbiA9IHRydWU7XG5cbiAgICBASW5wdXQoKVxuICAgIGNhbkJhY2tzcGFjZVJlbW92ZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgQElucHV0KClcbiAgICB2ZXJpZnlGbjogKHRhZ1NydDogc3RyaW5nKSA9PiBib29sZWFuO1xuXG4gICAgQElucHV0KClcbiAgICBzb3J0Rm46IChhOiBzdHJpbmcsIGI6IHN0cmluZykgPT4gbnVtYmVyO1xuXG4gICAgQElucHV0KClcbiAgICBzb3J0YWJsZTogYm9vbGVhbjtcblxuXG4gICAgX29uY2U6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIEBJbnB1dCgpXG4gICAgc2V0IG9uY2UodmFsdWU6IGJvb2xlYW4gfCBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgdGhpcy5fb25jZSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9vbmNlID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXQgb25jZSgpOiBib29sZWFuIHwgc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX29uY2U7XG4gICAgfVxuXG5cbiAgICBAT3V0cHV0KClcbiAgICBjaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQE91dHB1dCgpXG4gICAgaW9uRm9jdXM6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQE91dHB1dCgpXG4gICAgaW9uQmx1cjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICBAVmlld0NoaWxkKElvbklucHV0LCB7c3RhdGljOiBmYWxzZX0pXG4gICAgaW5wdXQ6IElvbklucHV0O1xuXG4gICAgX2VkaXRUYWc6IHN0cmluZyA9IFwiXCI7XG4gICAgX3RhZ3M6IHN0cmluZ1tdID0gW107XG4gICAgX2lzRm9jdXM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBfb25DaGFuZ2VkOiBGdW5jdGlvbjtcbiAgICBfb25Ub3VjaGVkOiBGdW5jdGlvbjtcblxuICAgIGtleUFkZFRhZygpOiBhbnkge1xuICAgICAgICBjb25zdCB0YWdTdHIgPSB0aGlzLl9lZGl0VGFnLnRyaW0oKTtcblxuICAgICAgICBpZiAoIXRoaXMuY2FuRW50ZXJBZGQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy52ZXJpZnlUYWcodGFnU3RyKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub25jZSAmJiAhdGhpcy5pc09uY2UodGFnU3RyKSkge1xuICAgICAgICAgICAgdGhpcy5fZWRpdFRhZyA9IFwiXCI7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnB1c2hUYWcodGFnU3RyKTtcbiAgICB9XG5cbiAgICBzZXBhcmF0b3JTdHJBZGRUYWcoKTogYW55IHtcblxuICAgICAgICBpZiAoIXRoaXMuc2VwYXJhdG9yU3RyKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fZWRpdFRhZy5pbmRleE9mKHRoaXMuc2VwYXJhdG9yU3RyKSA+IC0xKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLl9lZGl0VGFnLnNwbGl0KHRoaXMuc2VwYXJhdG9yU3RyKTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGFnID0gdGFnc1tpXS50cmltKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaSA8IHRhZ3MubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52ZXJpZnlUYWcodGFnKSAmJiB0aGlzLmlzT25jZSh0YWcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hUYWcodGFnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZWRpdFRhZyA9IHRhZztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBrZXlSZW1vdmVUYWcoZXY6IEV2ZW50KTogYW55IHtcblxuICAgICAgICBpZiAoIXRoaXMuY2FuQmFja3NwYWNlUmVtb3ZlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fZWRpdFRhZyA9PT0gXCJcIikge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVUYWcoLTEpO1xuICAgICAgICAgICAgdGhpcy5fZWRpdFRhZyA9IFwiXCI7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBidG5SZW1vdmVUYWcoJGluZGV4OiBudW1iZXIpOiBhbnkge1xuICAgICAgICB0aGlzLnJlbW92ZVRhZygkaW5kZXgpO1xuICAgICAgICB0aGlzLmlucHV0LnNldEZvY3VzKCk7XG4gICAgfVxuXG4gICAgdmVyaWZ5VGFnKHRhZ1N0cjogc3RyaW5nKTogYm9vbGVhbiB7XG5cbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZlcmlmeUZuID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy52ZXJpZnlGbih0YWdTdHIpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZWRpdFRhZyA9IFwiXCI7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGFnU3RyLnRyaW0oKSkge1xuICAgICAgICAgICAgdGhpcy5fZWRpdFRhZyA9IFwiXCI7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1c2hUYWcodGFnU3RyOiBzdHJpbmcpOiBhbnkge1xuXG4gICAgICAgIGlmICghdGhpcy5fdGFncykge1xuICAgICAgICAgICAgdGhpcy5fdGFncyA9IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX3RhZ3MuaW5kZXhPZih0YWdTdHIpID4gLTEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLm1heFRhZ3MgIT09IC0xICYmIHRoaXMuX3RhZ3MubGVuZ3RoID49IHRoaXMubWF4VGFncykge1xuICAgICAgICAgICAgdGhpcy5fZWRpdFRhZyA9IFwiXCI7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuXG4gICAgICAgIHRoaXMuX3RhZ3MucHVzaCh0YWdTdHIudHJpbSgpKTtcbiAgICAgICAgdGhpcy5zb3J0VGFncygpO1xuXG4gICAgICAgIHRoaXMucmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgdGhpcy5jaGFuZ2UuZW1pdCh0aGlzLl90YWdzLnNsaWNlKCkpO1xuICAgICAgICB0aGlzLl9lZGl0VGFnID0gXCJcIjtcblxuICAgICAgICBpZiAodGhpcy5fb25DaGFuZ2VkKSB7XG4gICAgICAgICAgICB0aGlzLl9vbkNoYW5nZWQodGhpcy5fdGFncy5zbGljZSgpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc29ydFRhZ3MoKSB7XG4gICAgICAgIGlmICh0aGlzLnNvcnRhYmxlICYmIHRoaXMuX3RhZ3MpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNvcnRGbikge1xuICAgICAgICAgICAgICAgIHRoaXMuX3RhZ3Muc29ydCgoYSwgYikgPT4gdGhpcy5zb3J0Rm4oYSwgYikpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl90YWdzLnNvcnQoKGEsIGIpID0+IGEubG9jYWxlQ29tcGFyZShiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW1vdmVUYWcoJGluZGV4OiBudW1iZXIpOiBhbnkge1xuICAgICAgICBpZiAodGhpcy5fdGFncyAmJiB0aGlzLl90YWdzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGlmICgkaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdGFncy5wb3AoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMuX3RhZ3MpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICgkaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3RhZ3Muc3BsaWNlKCRpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2UuZW1pdCh0aGlzLl90YWdzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuX29uQ2hhbmdlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX29uQ2hhbmdlZCh0aGlzLl90YWdzLnNsaWNlKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNPbmNlKHRhZ1N0cjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHRhZ3M6IHN0cmluZ1tdID0gdGhpcy5fdGFncztcblxuICAgICAgICBpZiAoIXRhZ3MpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRhZ3MuZXZlcnkoKGU6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGUgIT09IHRhZ1N0cjtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcihcImNsaWNrXCIsIFtcIiRldmVudFwiXSlcbiAgICBfY2xpY2soZXY6IFVJRXZlbnQpOiBhbnkge1xuICAgICAgICBpZiAoIXRoaXMuX2lzRm9jdXMpIHtcblxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZm9jdXMoKTtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGJsdXIoKSB7XG5cbiAgICAgICAgaWYgKHRoaXMuX2VkaXRUYWcpIHtcbiAgICAgICAgICAgIHRoaXMucHVzaFRhZyh0aGlzLl9lZGl0VGFnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9pc0ZvY3VzKSB7XG4gICAgICAgICAgICB0aGlzLl9pc0ZvY3VzID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmlvbkJsdXIuZW1pdCh0aGlzLl90YWdzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBmb2N1cygpOiBhbnkge1xuICAgICAgICBpZiAoIXRoaXMuX2lzRm9jdXMpIHtcbiAgICAgICAgICAgIHRoaXMuX2lzRm9jdXMgPSB0cnVlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbnB1dCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5pb25Gb2N1cy5lbWl0KHRoaXMuX3RhZ3MpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgd3JpdGVWYWx1ZSh2YWw6IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLl90YWdzID0gdmFsO1xuICAgIH1cblxuICAgIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLl9vbkNoYW5nZWQgPSBmbjtcbiAgICB9XG5cbiAgICByZWdpc3Rlck9uVG91Y2hlZChmbjogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX29uVG91Y2hlZCA9IGZuO1xuICAgIH1cblxuICAgIHNldFZhbHVlKHZhbDogYW55KTogYW55IHtcbiAgICAgICAgdGhpcy5fdGFncyA9IHZhbDtcbiAgICAgICAgdGhpcy5zb3J0VGFncygpO1xuICAgIH1cbn1cbiJdfQ==